id: universal-pr
version: "1.0"
specVersion: "0.8"
name: "Create Universal Pull/Merge Request"
description: "This workflow creates a pull request (GitHub) or merge request (GitLab) based on approvalTool parameter."
dataInputSchema: schemas/create-pr-universal-input-schema.json
functions:
  # Common functions
  - name: scafolderMock
    type: expression
    operation: |
      {
        "files": [
          {
            "path": "README.md",
            "content": "# Hello World"
          },
          {
            "path": "index.js",
            "content": "console.log('Hello, world!');"
          }
        ]
      }
  - name: sysLog
    type: custom
    operation: sysout:INFO
  
  # GitHub functions
  - name: getBranchSHA
    operation: specs/github.yaml#getBranchSHA
  - name: pushCommitBranch
    operation: specs/github.yaml#updateBranchRef
  - name: createCommit
    operation: specs/github.yaml#createCommit
  - name: createTree
    operation: specs/github.yaml#createTree
  - name: createBlob
    operation: specs/github.yaml#createBlob
  - name: createBranch
    operation: specs/github.yaml#createBranch
  - name: getCommitDetails
    operation: specs/github.yaml#getCommitDetails
  - name: createPullRequest
    operation: specs/github.yaml#createPullRequest
  - name: createNewBlob
    type: expression
    operation: '{"mode": "100644", "path": ($currentFile.path|tostring), "type": "blob", "sha": $WORKFLOW.prevActionResult.sha}'
  - name: githubSuccessResult
    type: expression
    operation: '{
        "result": {
          "message": "PR created",
          "outputs":[
              {
                "key": "PR_URL",
                "value": .prURL.html_url,
                "format":"link"
              }
            ]
        }
      }'
  
  # GitLab functions
  - name: searchProjects
    operation: specs/gitlab.yaml#searchProjects
  - name: getProject
    operation: specs/gitlab.yaml#getProject
  - name: gitlabCreateBranch
    operation: specs/gitlab.yaml#createBranch
  - name: gitlabCreateCommit
    operation: specs/gitlab.yaml#createCommit
  - name: gitlabCreateMergeRequest
    operation: specs/gitlab.yaml#createMergeRequest
  - name: gitlabSuccessResult
    type: expression
    operation: '{
        "result": {
          "message": "Merge Request created",
          "outputs":[
              {
                "key": "MR_URL",
                "value": .mrURL.web_url,
                "format":"link"
              }
            ]
        }
      }'

start: "GetScafolderData"
states:
  - name: GetScafolderData
    type: operation
    actions:
      - name: "Get Scafolder data"
        functionRef:
          refName: scafolderMock
        actionDataFilter:
          toStateData: .scafolderReponse
    transition: RouteToProvider
  
  - name: RouteToProvider
    type: switch
    dataConditions:
      - condition: '${ .approvalTool == "GIT" }'
        transition: GitHubCreateBranch
      - condition: '${ .approvalTool == "GITLAB" }'
        transition: GitLabSearchProject
    defaultCondition:
      transition: ErrorUnknownProvider

  - name: ErrorUnknownProvider
    type: inject
    data:
      error: "Unknown or unsupported approval tool"
      approvalTool: "${ .approvalTool }"
    end: true
  
  # GitHub workflow states
  - name: GitHubCreateBranch
    type: operation
    actions:
      - functionRef:
          refName: sysLog
          arguments:
            message: '${ "Creating GitHub branch for " + (.owner | tostring) + "/" + (.repo | tostring) }'
      - name: "GetHeadSha"
        functionRef:
          refName: getBranchSHA
          arguments:  
            owner: .owner
            repo: .repo
            ref: '"heads/" + .baseBranch'
        actionDataFilter:
          toStateData: .latestSHA
      - name: "createBranch"
        functionRef:
          refName: createBranch
          arguments:  
            owner: .owner
            repo: .repo
            ref: '"refs/heads/" + .targetBranch'
            sha: .latestSHA.object.sha
      - name: "getCommitDetails"
        functionRef:
          refName: getCommitDetails
          arguments:  
            owner: .owner
            repo: .repo
            commit_sha: .latestSHA.object.sha
        actionDataFilter:
          toStateData: .commit
    transition: GitHubCreateFiles
  
  - name: GitHubCreateFiles
    type: foreach
    inputCollection: "${ [.scafolderReponse.files[]] }"
    iterationParam: currentFile
    outputCollection: .blobs
    actions:
      - name: "createBlob"
        functionRef:
          refName: createBlob
          arguments:  
            owner: .owner
            repo: .repo
            content: ($currentFile.content|tostring)
            encoding: "utf-8"
      - name: createNewBlob
        functionRef:
          refName: createNewBlob
    transition: GitHubCreateNewTree
  
  - name: GitHubCreateNewTree
    type: operation
    actions:
      - name: "createTree"
        functionRef:
          refName: createTree
          arguments:  
            owner: .owner
            repo: .repo
            base_tree: .commit.tree.sha
            tree: .blobs
        actionDataFilter:
          toStateData: .newTree
      - name: "createCommit"
        functionRef:
          refName: createCommit
          arguments:  
            owner: .owner
            repo: .repo
            message: "Added/Updated multiple files via API"
            tree: .newTree.sha
            parents: [.latestSHA.object.sha]
        actionDataFilter:
          toStateData: .newCommit 
      - name: "push"
        functionRef:
          refName: pushCommitBranch
          arguments:  
            owner: .owner
            repo: .repo
            ref: '"heads/" + .targetBranch'
            sha: .newCommit.sha 
            force: false
    transition: GitHubCreatePR
  
  - name: GitHubCreatePR
    type: operation
    actions:
      - name: "createPullRequest"
        functionRef:
          refName: createPullRequest
          arguments:  
            owner: .owner
            repo: .repo
            title: "Automated PR"
            body: ""
            head: .targetBranch
            base: .baseBranch
        actionDataFilter:
          toStateData: .prURL   
      - name: setOutput
        functionRef:
          refName: githubSuccessResult
    end: true
  
  # GitLab workflow states
  - name: GitLabSearchProject
    type: operation
    actions:
      - functionRef:
          refName: sysLog
          arguments:
            message: '${ "Searching GitLab project: " + (.owner | tostring) + "/" + (.repo | tostring) }'
      - name: SearchProjects
        functionRef:
          refName: searchProjects
          arguments:
            search: .repo
            membership: true
            per_page: 100
        actionDataFilter:
          toStateData: .projectsList
    stateDataFilter:
      output: '${ . as $state | ($state.projectsList // []) | map(select(.path_with_namespace == ($state.owner + "/" + $state.repo)))[0] as $project | $state + {project: $project} }'
    transition: GitLabCreateBranch
  
  - name: GitLabCreateBranch
    type: operation
    actions:
      - functionRef:
          refName: sysLog
          arguments:
            message: '${ "Creating GitLab branch with project ID: " + (.project.id | tostring) }'
      - name: "createBranch"
        functionRef:
          refName: gitlabCreateBranch
          arguments:
            id: .project.id | tostring
            branch: .targetBranch
            ref: .baseBranch
    transition: GitLabCreateCommit
  
  - name: GitLabCreateCommit
    type: operation
    actions:
      - name: "createCommit"
        functionRef:
          refName: gitlabCreateCommit
          arguments:
            id: .project.id | tostring
            branch: .targetBranch
            commit_message: "Added/Updated multiple files via API"
            actions: '${ .scafolderReponse.files | map({ "action": "create", "file_path": .path, "content": .content }) }'
    transition: GitLabCreateMR
  
  - name: GitLabCreateMR
    type: operation
    actions:
      - name: "createMergeRequest"
        functionRef:
          refName: gitlabCreateMergeRequest
          arguments:
            id: .project.id | tostring
            source_branch: .targetBranch
            target_branch: .baseBranch
            title: "Automated MR"
        actionDataFilter:
          toStateData: .mrURL
      - name: setOutput
        functionRef:
          refName: gitlabSuccessResult
    end: true

